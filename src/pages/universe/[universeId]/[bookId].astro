---
import BaseLayout from '../../../layouts/BaseLayout.astro';
import { getCollection, render } from 'astro:content';

export async function getStaticPaths() {
  const universes = await getCollection('universes');
  const books = await getCollection('books');

  return books.map((book) => {
    const universe = universes.find((u) => u.id.replace(/\.md$/, '') === book.data.universe);
    return {
      params: { universeId: book.data.universe, bookId: book.id.replace(/\.md$/, '') },
      props: { book, universe },
    };
  });
}

function slug(id: string) {
  return id.replace(/\.md$/, '');
}

const { book, universe } = Astro.props;
const { Content } = await render(book);

// Find next book in same series (sequential only)
const allBooks = await getCollection('books');
const seriesBooks = allBooks
  .filter((b) => b.data.series === book.data.series && b.data.universe === book.data.universe)
  .sort((a, b) => a.data.order - b.data.order);
const nextBook = seriesBooks.length > 1
  ? seriesBooks.find((b) => b.data.order === book.data.order + 1)
  : undefined;

const buyLinks = [
  { label: 'Kindle', url: book.data.kindle },
  { label: 'Barnes & Noble', url: book.data.barnesNoble },
  { label: 'Kobo', url: book.data.kobo },
  { label: 'Apple Books', url: book.data.apple },
  { label: 'Paperback', url: book.data.paperback },
].filter((link) => link.url);
---
<BaseLayout
  title={`${book.data.title} — Matthew Taylor`}
  description={book.data.blurb}
  theme={universe?.data.theme}
  accent={universe?.data.accent}
  accentGlow={universe?.data.accentGlow}
  music={universe?.data.music}
>
  <div class="container">
    <a href={`/universe/${book.data.universe}`} class="back-link">&larr; Back to {universe?.data.name}</a>

    <div class="book-detail">
      <div class="book-detail__cover">
        {book.data.cover
          ? <img src={book.data.cover} alt={`${book.data.title} cover`} />
          : <span>{book.data.title}</span>
        }
      </div>

      <div>
        <span class="book-detail__series">{book.data.series !== book.data.title ? `${book.data.series} · Book ${book.data.order}` : book.data.series}</span>
        <h1 class="book-detail__title">{book.data.title}</h1>
        <p class="book-detail__blurb">{book.data.blurb}</p>

        {buyLinks.length > 0 && (
          <div class="buy-links">
            {buyLinks.map((link) => (
              <a href={link.url} class="buy-link" target="_blank" rel="noopener noreferrer">
                {link.label}
              </a>
            ))}
          </div>
        )}

        <div class="book-detail__content">
          <Content />
        </div>

        {nextBook && (
          <a href={`/universe/${book.data.universe}/${slug(nextBook.id)}`} class="next-book">
            <span class="next-book__label">Next in the series</span>
            <div class="next-book__preview">
              {nextBook.data.cover
                ? <img src={nextBook.data.cover} alt={`${nextBook.data.title} cover`} class="next-book__cover" />
                : <div class="next-book__cover next-book__cover--placeholder">{nextBook.data.title}</div>
              }
              <div class="next-book__info">
                <span class="next-book__title">{nextBook.data.title}</span>
                <span class="next-book__series">{nextBook.data.series} &middot; Book {nextBook.data.order}</span>
              </div>
            </div>
          </a>
        )}
      </div>
    </div>
  </div>
</BaseLayout>
