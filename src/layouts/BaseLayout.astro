---
import '../styles/global.css';

interface Props {
  title: string;
  description?: string;
  theme?: 'landing' | 'scifi' | 'fantasy';
  accent?: string;
  accentGlow?: string;
  music?: string;
}

const {
  title,
  description = "Matthew Taylor — One Author, Two Genres. Carefully-crafted, character-driven science fiction and fantasy.",
  theme = 'landing',
  accent,
  accentGlow,
  music,
} = Astro.props;
---
<html lang="en" data-theme={theme}>
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content={description} />
    <meta name="generator" content={Astro.generator} />
    <meta name="robots" content="noindex, nofollow" />
    <title>{title}</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700;900&family=EB+Garamond:wght@400;500;600&family=Inter:wght@300;400;500;600&family=Orbitron:wght@500;700;900&family=Rajdhani:wght@300;400;500;600&display=swap"
      rel="stylesheet"
    />

    <!-- MailerLite Universal -->
    <script is:inline>
      (function(w,d,e,u,f,l,n){w[f]=w[f]||function(){(w[f].q=w[f].q||[]).push(arguments);},l=d.createElement(e),l.async=1,l.src=u,n=d.getElementsByTagName(e)[0],n.parentNode.insertBefore(l,n);})
      (window,document,'script','https://assets.mailerlite.com/js/universal.js','ml');
      ml('account', '2110846');
    </script>

    {accent && (
      <style define:vars={{ accent, accentGlow }}>
        :root {
          --color-accent: var(--accent);
          --color-accent-glow: var(--accentGlow);
        }
      </style>
    )}
  </head>
  <body>
    <header class="site-header">
      <div class="container">
        <a href="/" class="site-logo">Author M.P. Tayle</a>
        <button class="nav-toggle" aria-label="Toggle navigation">&#9776;</button>
        <nav>
          <ul class="site-nav">
            <li><a href="javascript:void(0)" onclick="document.getElementById('about-modal').showModal()">About</a></li>
            <li><a class="ml-onclick-form" href="javascript:void(0)" onclick="ml('show', 'WE9oBU', true)">Newsletter</a></li>
          </ul>
        </nav>
      </div>
    </header>

    <main>
      <slot />
    </main>

    <footer class="site-footer">
      <div class="container">
        <p>&copy; {new Date().getFullYear()} Matthew Taylor. All rights reserved.</p>
        {music && (
          <p class="music-credit">Music by <a href="https://incompetech.com" target="_blank" rel="noopener noreferrer">Kevin MacLeod</a> (incompetech.com) &mdash; Licensed under <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank" rel="noopener noreferrer">CC BY 4.0</a></p>
        )}
      </div>
    </footer>

    {music && (
      <div class="audio-widget">
        <svg class="audio-widget__text" viewBox="0 0 120 120" width="120" height="120">
          <defs>
            <path id="curve" d="M 60,60 m -42,0 a 42,42 0 1,1 84,0 a 42,42 0 1,1 -84,0" fill="none" />
          </defs>
          <text>
            <textPath href="#curve" startOffset="50%" text-anchor="middle">Oh, thematic music?</textPath>
          </text>
        </svg>
        <button class="audio-player" id="audio-player" aria-label="Play ambient music" data-music={music}>
          <svg class="audio-player__icon audio-player__icon--play" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
            <path d="M8 5v14l11-7z"/>
          </svg>
          <svg class="audio-player__icon audio-player__icon--pause" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
          </svg>
        </button>
      </div>
    )}

    <dialog id="about-modal" class="about-modal">
      <div class="about-modal__content">
        <button class="about-modal__close" onclick="document.getElementById('about-modal').close()" aria-label="Close">&times;</button>
        <img src="/images/author-photo.jpg" alt="M.P. Tayle" class="about-modal__photo" />
        <h2 class="about-modal__name">M.P. Tayle</h2>
        <p class="about-modal__bio">M.P. Tayle (Matthew Taylor) spent years as a Cyber Operations Sergeant in the United States Army, which is a fancy way of saying he knows exactly how technology can go sideways — and loves writing stories about what happens when it does. He's the author of the Jax Jensen Trilogy and writes science fiction and fantasy that's equal parts adventure, heart, and "oh no, that could actually happen."</p>
        <p class="about-modal__bio">When not writing, he's rolling dice over Warhammer 40,000, drawing on Procreate, and being bossed around by a Maltipoo who thinks she runs the house.</p>
      </div>
    </dialog>

    <script>
      const toggle = document.querySelector('.nav-toggle');
      const nav = document.querySelector('.site-nav');
      if (toggle && nav) {
        toggle.addEventListener('click', () => nav.classList.toggle('open'));
      }

      // About modal — close on backdrop click
      const aboutModal = document.getElementById('about-modal') as HTMLDialogElement | null;
      if (aboutModal) {
        aboutModal.addEventListener('click', (e) => {
          if (e.target === aboutModal) aboutModal.close();
        });
      }

      // Ambient audio player
      const playerBtn = document.getElementById('audio-player') as HTMLButtonElement | null;
      if (playerBtn) {
        const musicSrc = playerBtn.dataset.music!;
        const storedSrc = sessionStorage.getItem('ambientMusicSrc');
        const wasPlaying = sessionStorage.getItem('ambientMusicPlaying') === 'true';

        let audio: HTMLAudioElement;

        // Reuse existing audio element if same track, otherwise create new
        const existingAudio = document.getElementById('ambient-audio') as HTMLAudioElement | null;
        if (existingAudio && storedSrc === musicSrc) {
          audio = existingAudio;
        } else {
          if (existingAudio) {
            existingAudio.pause();
            existingAudio.remove();
          }
          audio = document.createElement('audio');
          audio.id = 'ambient-audio';
          audio.src = musicSrc;
          audio.loop = true;
          audio.volume = 0.3;
          audio.preload = 'none';
          document.body.appendChild(audio);

          // If switching universes, stop playback
          if (storedSrc && storedSrc !== musicSrc) {
            sessionStorage.setItem('ambientMusicPlaying', 'false');
            sessionStorage.setItem('ambientMusicSrc', musicSrc);
          }
        }

        function updateButton(playing: boolean) {
          playerBtn!.classList.toggle('playing', playing);
          playerBtn!.setAttribute('aria-label', playing ? 'Pause ambient music' : 'Play ambient music');
        }

        // Restore play state if same track was playing
        if (wasPlaying && storedSrc === musicSrc) {
          audio.preload = 'auto';
          audio.play().then(() => updateButton(true)).catch(() => updateButton(false));
        }

        playerBtn.addEventListener('click', () => {
          if (audio.paused) {
            audio.play().then(() => {
              updateButton(true);
              sessionStorage.setItem('ambientMusicPlaying', 'true');
              sessionStorage.setItem('ambientMusicSrc', musicSrc);
            }).catch(() => {});
          } else {
            audio.pause();
            updateButton(false);
            sessionStorage.setItem('ambientMusicPlaying', 'false');
          }
        });
      }
    </script>
  </body>
</html>
